#!/bin/bash
# mindriverdb

# Stop on errors
# See https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/
set -Eeuo pipefail

DB_NAME="var/mindriver.db"
DB_UPLOADS="var/uploads"

# Sanity check command line options
usage() {
  	echo "Usage: $0 (create|destroy|reset)"
}

create() {
	CREATE_TABLE_SQL="CREATE TABLE IF NOT EXISTS users (
		username TEXT PRIMARY KEY,
		firstname TEXT NOT NULL,
		lastname TEXT NOT NULL,
		email TEXT NOT NULL UNIQUE,
		filename TEXT,
		password TEXT NOT NULL,
		dob TEXT NOT NULL,
		gender TEXT NOT NULL
	);"
	if [ -f "$DB_NAME" ]; then
    	echo "Database $DB_NAME already exists."
	else
		# Create a new SQLite database
		sqlite3 $DB_NAME "$CREATE_TABLE_SQL"	
		mkdir -p $DB_UPLOADS
		if [ $? -eq 0 ]; then
			echo "Database and table created successfully."
		else
			echo "Failed to create database or table."
		fi
	fi
}

destroy() {
	rm -rf $DB_NAME $DB_UPLOADS
}

reset() {
	destroy
	create
}

if [ $# -ne 1 ]; then
  	usage
  	exit 1
fi

# Parse argument.  $1 is the first argument
case $1 in
  	"create")
	  	create
	  	;;
	"destroy")
		destroy
		;;
	"reset")
		destroy
		create
		;;
  	*)
    	usage
    	exit 1
    	;;
esac